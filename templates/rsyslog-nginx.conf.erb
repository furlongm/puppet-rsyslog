upstream kibana  {
        server 127.0.0.1:5601;
    }

upstream elasticsearch  {
        server 127.0.0.1:9200;
    }

log_format upstream_log '$upstream_status $upstream_addr $request '
'upstream_response_time $upstream_response_time '
'msec $msec request_time $request_time';

server {

    listen 80;
    server_name <%= fqdn %>;

    access_log  /var/log/nginx/access.log;
    access_log  /var/log/nginx/upstream.log upstream_log;

    client_max_body_size 5G;
    client_body_timeout 60s;

    location /kibana/ {
        proxy_pass http://kibana/ ;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect default;
<%- nagios_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
<%- admin_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
        deny all;
    }

    location /es/ {
        proxy_pass http://elasticsearch/_plugin/head/ ;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect default;
<%- nagios_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
<%- admin_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
        deny all;
    }

    location /nginx_status {
        stub_status on;
        access_log off;
<%- nagios_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
<%- admin_hosts.each do |server| -%>
        allow <%= server %>;
<% end -%>
        deny all;
    }
}
